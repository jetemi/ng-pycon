{% extends base_template %}
{% load static %}

{% block title %}CFP Dashboard - PyCon Nigeria {{ conference_year }}{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100">

    <section class="py-12 px-4">
        <div class="max-w-7xl mx-auto">

            <!-- Header -->
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 mb-1">CFP Dashboard</h1>
                    <p class="text-gray-600">
                        PyCon Nigeria {{ conference_year }}
                        {% if cfp %}
                        — Status:
                        <span class="font-semibold
                            {% if cfp.status == 'open' %}text-green-600
                            {% elif cfp.status == 'closed' %}text-red-600
                            {% else %}text-yellow-600{% endif %}">
                            {{ cfp.get_status_display }}
                        </span>
                        {% endif %}
                    </p>
                </div>
                <div class="mt-4 sm:mt-0 flex gap-2">
                    <a href="{% url 'cfp:admin_export' %}?format=csv"
                       class="px-4 py-2 border border-gray-300 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-50 transition-colors">
                        Export CSV
                    </a>
                    <a href="{% url 'cfp:admin_export' %}?format=json"
                       class="px-4 py-2 border border-gray-300 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-50 transition-colors">
                        Export JSON
                    </a>
                </div>
            </div>

            {% if messages %}
            <div class="mb-6">
                {% for message in messages %}
                <div class="px-4 py-3 rounded-lg text-sm font-medium
                    {% if message.tags == 'success' %}bg-green-100 text-green-800
                    {% elif message.tags == 'error' %}bg-red-100 text-red-800
                    {% else %}bg-blue-100 text-blue-800{% endif %}">
                    {{ message }}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Stats Grid -->
            <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 text-center">
                    <div class="text-2xl font-bold text-gray-900">{{ stats.total }}</div>
                    <div class="text-xs text-gray-500 uppercase tracking-wide mt-1">Total</div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 text-center">
                    <div class="text-2xl font-bold text-blue-600">{{ stats.submitted }}</div>
                    <div class="text-xs text-gray-500 uppercase tracking-wide mt-1">Submitted</div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 text-center">
                    <div class="text-2xl font-bold text-yellow-600">{{ stats.under_review }}</div>
                    <div class="text-xs text-gray-500 uppercase tracking-wide mt-1">Under Review</div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 text-center">
                    <div class="text-2xl font-bold text-green-600">{{ stats.accepted }}</div>
                    <div class="text-xs text-gray-500 uppercase tracking-wide mt-1">Accepted</div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 text-center">
                    <div class="text-2xl font-bold text-emerald-600">{{ stats.confirmed }}</div>
                    <div class="text-xs text-gray-500 uppercase tracking-wide mt-1">Confirmed</div>
                </div>
            </div>

            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mb-8">
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 text-center">
                    <div class="text-xl font-bold text-red-600">{{ stats.rejected }}</div>
                    <div class="text-xs text-gray-500 uppercase tracking-wide mt-1">Rejected</div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 text-center">
                    <div class="text-xl font-bold text-amber-600">{{ stats.waitlisted }}</div>
                    <div class="text-xs text-gray-500 uppercase tracking-wide mt-1">Waitlisted</div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 text-center">
                    <div class="text-xl font-bold text-gray-500">{{ stats.withdrawn }}</div>
                    <div class="text-xs text-gray-500 uppercase tracking-wide mt-1">Withdrawn</div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 text-center">
                    <div class="text-xl font-bold text-gray-400">{{ stats.draft }}</div>
                    <div class="text-xs text-gray-500 uppercase tracking-wide mt-1">Drafts</div>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
                <form method="get" class="flex flex-wrap items-center gap-3">
                    <label class="text-sm font-medium text-gray-700">Filter:</label>
                    <select name="status"
                            class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-teal-500">
                        <option value="">All Statuses</option>
                        {% for value, label in status_choices %}
                        <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                    <select name="track"
                            class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm bg-white focus:outline-none focus:ring-2 focus:ring-teal-500">
                        <option value="">All Tracks</option>
                        {% for track in tracks %}
                        <option value="{{ track.pk }}" {% if track_filter == track.pk|stringformat:"d" %}selected{% endif %}>{{ track.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit"
                            class="px-4 py-1.5 bg-teal-600 hover:bg-teal-700 text-white text-sm font-semibold rounded-lg transition-colors">
                        Apply
                    </button>
                    {% if status_filter or track_filter %}
                    <a href="{% url 'cfp:admin_dashboard' %}" class="text-sm text-gray-500 hover:text-gray-700">Clear</a>
                    {% endif %}
                </form>
            </div>

            <!-- Proposals list with bulk actions -->
            <form method="post" id="bulk-form">
                {% csrf_token %}

                <!-- Bulk action bar -->
                <div class="bg-white rounded-t-xl shadow-sm border border-gray-100 border-b-0 p-4 flex flex-wrap items-center gap-3"
                     x-data="{ selectedIds: [] }">

                    <span class="text-sm text-gray-600" x-text="selectedIds.length + ' selected'"></span>

                    <!-- Bulk decisions -->
                    <select name="decision" class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm bg-white">
                        <option value="accept">Accept</option>
                        <option value="reject">Reject</option>
                        <option value="waitlist">Waitlist</option>
                    </select>
                    <button type="submit"
                            formaction="{% url 'cfp:admin_decisions' %}"
                            class="px-4 py-1.5 bg-teal-600 hover:bg-teal-700 text-white text-sm font-semibold rounded-lg transition-colors"
                            onclick="document.getElementById('proposal_ids').value = this.closest('[x-data]').__x.$data.selectedIds.join(',')">
                        Apply Decision
                    </button>

                    <!-- Bulk email -->
                    <select name="template_type" class="px-3 py-1.5 border border-gray-300 rounded-lg text-sm bg-white ml-auto">
                        <option value="acceptance">Acceptance Email</option>
                        <option value="rejection">Rejection Email</option>
                        <option value="waitlist">Waitlist Email</option>
                    </select>
                    <button type="submit"
                            formaction="{% url 'cfp:admin_email' %}"
                            class="px-4 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold rounded-lg transition-colors"
                            onclick="document.getElementById('proposal_ids').value = this.closest('[x-data]').__x.$data.selectedIds.join(',')">
                        Send Emails
                    </button>

                    <input type="hidden" name="proposal_ids" id="proposal_ids" value="">
                </div>

                <!-- Table -->
                <div class="bg-white rounded-b-xl shadow-sm border border-gray-100 overflow-x-auto"
                     x-data="{ allChecked: false }">
                    <table class="w-full">
                        <thead class="bg-gray-50 border-b border-gray-200">
                            <tr>
                                <th class="px-4 py-3 w-10">
                                    <input type="checkbox" class="w-4 h-4" x-model="allChecked"
                                           @change="document.querySelectorAll('.proposal-checkbox').forEach(cb => cb.checked = allChecked)">
                                </th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide">Title</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide hidden md:table-cell">Speaker</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide hidden lg:table-cell">Track</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase tracking-wide hidden sm:table-cell">Score</th>
                                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase tracking-wide">Status</th>
                                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wide hidden lg:table-cell">Submitted</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                            {% for proposal in proposals %}
                            <tr class="hover:bg-gray-50 transition-colors">
                                <td class="px-4 py-3">
                                    <input type="checkbox" class="w-4 h-4 proposal-checkbox" value="{{ proposal.pk }}"
                                           @change="let parent = $el.closest('[x-data]').parentElement.parentElement.previousElementSibling.querySelector('[x-data]');
                                                    let cbs = document.querySelectorAll('.proposal-checkbox:checked');
                                                    parent.__x.$data.selectedIds = Array.from(cbs).map(cb => cb.value);">
                                </td>
                                <td class="px-4 py-3">
                                    <div class="font-medium text-gray-900 text-sm">{{ proposal.title|truncatewords:8 }}</div>
                                    <div class="text-xs text-gray-400">{{ proposal.get_format_display }} · {{ proposal.duration }}min</div>
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-600 hidden md:table-cell">
                                    {{ proposal.speaker.full_name }}
                                </td>
                                <td class="px-4 py-3 text-sm text-gray-600 hidden lg:table-cell">
                                    {{ proposal.track.name|default:"—" }}
                                </td>
                                <td class="px-4 py-3 text-center hidden sm:table-cell">
                                    {% if proposal.average_score %}
                                    <span class="font-semibold text-sm">{{ proposal.average_score|floatformat:1 }}</span>
                                    <span class="text-xs text-gray-400">({{ proposal.review_count }})</span>
                                    {% else %}
                                    <span class="text-xs text-gray-400">—</span>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-3 text-center">
                                    {% if proposal.status == 'submitted' %}
                                    <span class="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded-full">Submitted</span>
                                    {% elif proposal.status == 'under_review' %}
                                    <span class="text-xs px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full">Review</span>
                                    {% elif proposal.status == 'accepted' %}
                                    <span class="text-xs px-2 py-1 bg-green-100 text-green-700 rounded-full">Accepted</span>
                                    {% elif proposal.status == 'rejected' %}
                                    <span class="text-xs px-2 py-1 bg-red-100 text-red-700 rounded-full">Rejected</span>
                                    {% elif proposal.status == 'waitlisted' %}
                                    <span class="text-xs px-2 py-1 bg-amber-100 text-amber-700 rounded-full">Waitlisted</span>
                                    {% elif proposal.status == 'confirmed' %}
                                    <span class="text-xs px-2 py-1 bg-emerald-100 text-emerald-700 rounded-full">Confirmed</span>
                                    {% elif proposal.status == 'withdrawn' %}
                                    <span class="text-xs px-2 py-1 bg-gray-200 text-gray-500 rounded-full">Withdrawn</span>
                                    {% endif %}
                                </td>
                                <td class="px-4 py-3 text-xs text-gray-400 hidden lg:table-cell">
                                    {{ proposal.submitted_at|date:"M j" }}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="7" class="px-4 py-8 text-center text-gray-500">
                                    No proposals found.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </form>

        </div>
    </section>

</div>
{% endblock %}
